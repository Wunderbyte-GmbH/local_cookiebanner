{"version":3,"file":"banner.min.js","sources":["../src/banner.js"],"sourcesContent":["/**\n * @module local_cookiebanner/banner\n * @copyright 2024\n * @license   https://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Templates from 'core/templates';\nimport ModalFactory from 'core/modal_factory';\nimport {getString} from 'core/str';\nimport * as Setcookie from 'local_cookiebanner/init'; // ← import your init module\nlet bannerisopen = false;\n\nexport const showbanner = (text, showadvanced, advancedtext, loggedin) => {\n    if (bannerisopen) {\n        return;\n    }\n    bannerisopen = true; // ✅ Lock\n    return Templates.renderForPromise('local_cookiebanner/bannercard', {\n        text,\n        showadvanced\n    }).then(({ html, js }) => {\n        const container = document.createElement('div');\n        container.innerHTML = html;\n        const banner = container.firstElementChild;\n\n        if (!banner) {\n            throw new Error(\"Template did not return valid HTML.\");\n        }\n\n        document.body.appendChild(banner);\n        Templates.runTemplateJS(js);\n\n        const moodleIdCheckbox = banner.querySelector(\"#cookie-moodle-id\");\n\n        if (moodleIdCheckbox && localStorage.getItem(\"cookie_consent_remember\") === \"setall\") {\n            moodleIdCheckbox.checked = true;\n        }\n        const closeBanner = () => {\n            banner.remove();\n            bannerisopen = false;\n        };\n\n        banner.querySelector(\"#cookie-accept-all\")?.addEventListener(\"click\", () => {\n            localStorage.setItem(\"cookie_consent_remember\", \"all\");\n            closeBanner();\n            if (loggedin) {\n                Setcookie.init();\n            }\n        });\n\n        banner.querySelector(\"#cookie-save\")?.addEventListener(\"click\", () => {\n            const moodleIdCheckbox = banner.querySelector(\"#cookie-moodle-id\");\n            if (moodleIdCheckbox?.checked) {\n                localStorage.setItem(\"cookie_consent_remember\", \"all\");\n                Setcookie.init();\n            } else {\n                Setcookie.init();\n                localStorage.setItem(\"cookie_consent_remember\", \"tech\");\n            }\n            closeBanner();\n        });\n\n        const settingsButton = banner.querySelector(\"#cookie-settings\");\n        if (showadvanced && settingsButton) {\n            settingsButton.addEventListener(\"click\", () => {\n                ModalFactory.create({\n                    title: getString('modalheader', 'local_cookiebanner'),\n                    body: advancedtext,\n                }).then(modal => modal.show())\n                  .catch(error =>\n                    // eslint-disable-next-line no-console\n                    console.error('Modal creation failed:', error));\n            });\n        } else if (settingsButton) {\n            settingsButton.style.display = \"none\";\n        }\n\n        return null;\n    }).catch(error => {\n        // eslint-disable-next-line no-console\n        console.error('Failed to render cookie banner:', error);\n        bannerisopen = false; // 🔓 Reset lock on failure\n    });\n};\n\n\nexport const init = (text, showadvanced, advancedtext, loggedin) => {\n    if (localStorage.getItem(\"cookie_consent_remember\")) {\n        return Promise.resolve();\n    }\n\n    return showbanner(text, showadvanced, advancedtext, loggedin);\n};\n"],"names":["bannerisopen","showbanner","text","showadvanced","advancedtext","loggedin","Templates","renderForPromise","then","_ref","html","js","container","document","createElement","innerHTML","banner","firstElementChild","Error","body","appendChild","runTemplateJS","moodleIdCheckbox","querySelector","localStorage","getItem","checked","closeBanner","remove","addEventListener","setItem","Setcookie","init","settingsButton","create","title","modal","show","catch","error","console","style","display","Promise","resolve"],"mappings":";;;;;g3BAUIA,cAAe,QAENC,WAAa,CAACC,KAAMC,aAAcC,aAAcC,gBACrDL,oBAGJA,cAAe,EACRM,mBAAUC,iBAAiB,gCAAiC,CAC/DL,KAAAA,KACAC,aAAAA,eACDK,MAAKC,4DAACC,KAAEA,KAAFC,GAAQA,eACPC,UAAYC,SAASC,cAAc,OACzCF,UAAUG,UAAYL,WAChBM,OAASJ,UAAUK,sBAEpBD,aACK,IAAIE,MAAM,uCAGpBL,SAASM,KAAKC,YAAYJ,2BAChBK,cAAcV,UAElBW,iBAAmBN,OAAOO,cAAc,qBAE1CD,kBAAwE,WAApDE,aAAaC,QAAQ,6BACzCH,iBAAiBI,SAAU,SAEzBC,YAAc,KAChBX,OAAOY,SACP5B,cAAe,iCAGnBgB,OAAOO,cAAc,8EAAuBM,iBAAiB,SAAS,KAClEL,aAAaM,QAAQ,0BAA2B,OAChDH,cACItB,UACA0B,UAAUC,yCAIlBhB,OAAOO,cAAc,0EAAiBM,iBAAiB,SAAS,WACtDP,iBAAmBN,OAAOO,cAAc,qBAC1CD,MAAAA,kBAAAA,iBAAkBI,SAClBF,aAAaM,QAAQ,0BAA2B,OAChDC,UAAUC,SAEVD,UAAUC,OACVR,aAAaM,QAAQ,0BAA2B,SAEpDH,uBAGEM,eAAiBjB,OAAOO,cAAc,2BACxCpB,cAAgB8B,eAChBA,eAAeJ,iBAAiB,SAAS,4BACxBK,OAAO,CAChBC,OAAO,kBAAU,cAAe,sBAChChB,KAAMf,eACPI,MAAK4B,OAASA,MAAMC,SACpBC,OAAMC,OAELC,QAAQD,MAAM,yBAA0BA,YAEzCN,iBACPA,eAAeQ,MAAMC,QAAU,QAG5B,QACRJ,OAAMC,QAELC,QAAQD,MAAM,kCAAmCA,OACjDvC,cAAe,mDAKH,CAACE,KAAMC,aAAcC,aAAcC,WAC/CmB,aAAaC,QAAQ,2BACdkB,QAAQC,UAGZ3C,WAAWC,KAAMC,aAAcC,aAAcC"}