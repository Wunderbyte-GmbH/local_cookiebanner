{"version":3,"file":"banner.min.js","sources":["../src/banner.js"],"sourcesContent":["/**\n * @module local_cookiebanner/banner\n * @copyright 2024\n * @license   https://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Templates from 'core/templates';\nimport ModalFactory from 'core/modal_factory';\nimport {getString} from 'core/str';\nimport * as Setcookie from 'local_cookiebanner/init'; // ← import your init module\nlet bannerisopen = false;\n\nexport const showbanner = (templatedata, loggedin) => {\n    if (bannerisopen) {\n        return;\n    }\n    bannerisopen = true;\n    return Templates.renderForPromise('local_cookiebanner/bannercard',\n        {'templatedata': templatedata}\n    ).then(({ html, js }) => {\n        const container = document.createElement('div');\n        container.innerHTML = html;\n        const banner = container.firstElementChild;\n\n        if (!banner) {\n            throw new Error(\"Template did not return valid HTML.\");\n        }\n\n        document.body.appendChild(banner);\n        Templates.runTemplateJS(js);\n\n        const moodleIdCheckbox = banner.querySelector(\"#cookie-moodle-id\");\n\n        if (moodleIdCheckbox && localStorage.getItem(\"cookie_consent_remember\") === \"setall\") {\n            moodleIdCheckbox.checked = true;\n        }\n        const closeBanner = () => {\n            banner.remove();\n            bannerisopen = false;\n        };\n\n        banner.querySelector(\"#cookie-accept-all\")?.addEventListener(\"click\", () => {\n            localStorage.setItem(\"cookie_consent_remember\", \"all\");\n            closeBanner();\n            if (loggedin) {\n                Setcookie.init();\n            }\n        });\n\n        banner.querySelector(\"#cookie-save\")?.addEventListener(\"click\", () => {\n            const moodleIdCheckbox = banner.querySelector(\"#cookie-moodle-id\");\n            if (moodleIdCheckbox?.checked) {\n                localStorage.setItem(\"cookie_consent_remember\", \"all\");\n                Setcookie.init();\n            } else {\n                localStorage.setItem(\"cookie_consent_remember\", \"tech\");\n                Setcookie.init();\n            }\n            closeBanner();\n        });\n\n        const settingsButton = banner.querySelector(\"#cookie-settings\");\n        // if (templatedata.showadvanced && settingsButton) {\n        //     settingsButton.addEventListener(\"click\", () => {\n        //         ModalFactory.create({\n        //             title: getString('modalheader', 'local_cookiebanner'),\n        //             body: templatedata.advancedtext,\n        //         }).then(modal => modal.show())\n        //           .catch(error =>\n        //             // eslint-disable-next-line no-console\n        //             console.error('Modal creation failed:', error));\n        //     });\n        // } else if (settingsButton) {\n        //     settingsButton.style.display = \"none\";\n        // }\n\n        return null;\n    }).catch(error => {\n        // eslint-disable-next-line no-console\n        console.error('Failed to render cookie banner:', error);\n        bannerisopen = false; // 🔓 Reset lock on failure\n    });\n};\n\n\nexport const init = (data, loggedin) => {\n    if (localStorage.getItem(\"cookie_consent_remember\")) {\n        return Promise.resolve();\n    }\n\n    return showbanner(data, loggedin);\n};\n"],"names":["bannerisopen","showbanner","templatedata","loggedin","Templates","renderForPromise","then","_ref","html","js","container","document","createElement","innerHTML","banner","firstElementChild","Error","body","appendChild","runTemplateJS","moodleIdCheckbox","querySelector","localStorage","getItem","checked","closeBanner","remove","addEventListener","setItem","Setcookie","init","catch","error","console","data","Promise","resolve"],"mappings":";;;;;g3BAUIA,cAAe,QAENC,WAAa,CAACC,aAAcC,gBACjCH,oBAGJA,cAAe,EACRI,mBAAUC,iBAAiB,gCAC9B,cAAiBH,eACnBI,MAAKC,4DAACC,KAAEA,KAAFC,GAAQA,eACNC,UAAYC,SAASC,cAAc,OACzCF,UAAUG,UAAYL,WAChBM,OAASJ,UAAUK,sBAEpBD,aACK,IAAIE,MAAM,uCAGpBL,SAASM,KAAKC,YAAYJ,2BAChBK,cAAcV,UAElBW,iBAAmBN,OAAOO,cAAc,qBAE1CD,kBAAwE,WAApDE,aAAaC,QAAQ,6BACzCH,iBAAiBI,SAAU,SAEzBC,YAAc,KAChBX,OAAOY,SACP1B,cAAe,iCAGnBc,OAAOO,cAAc,8EAAuBM,iBAAiB,SAAS,KAClEL,aAAaM,QAAQ,0BAA2B,OAChDH,cACItB,UACA0B,UAAUC,yCAIlBhB,OAAOO,cAAc,0EAAiBM,iBAAiB,SAAS,WACtDP,iBAAmBN,OAAOO,cAAc,qBAC1CD,MAAAA,kBAAAA,iBAAkBI,SAClBF,aAAaM,QAAQ,0BAA2B,OAChDC,UAAUC,SAEVR,aAAaM,QAAQ,0BAA2B,QAChDC,UAAUC,QAEdL,iBAGmBX,OAAOO,cAAc,2BAerC,QACRU,OAAMC,QAELC,QAAQD,MAAM,kCAAmCA,OACjDhC,cAAe,mDAKH,CAACkC,KAAM/B,WACnBmB,aAAaC,QAAQ,2BACdY,QAAQC,UAGZnC,WAAWiC,KAAM/B"}