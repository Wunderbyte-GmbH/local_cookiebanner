{"version":3,"file":"banner.min.js","sources":["../src/banner.js"],"sourcesContent":["/**\n * @module local_cookiebanner/banner\n * @copyright 2024\n * @license   https://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Templates from 'core/templates';\nimport ModalFactory from 'core/modal_factory';\nimport { getString } from 'core/str';\nimport * as Setcookie from 'local_cookiebanner/init';\nimport { getDBItem, setDBItem } from 'local_cookiebanner/db';\n\nlet bannerisopen = false;\n\nexport const showbanner = async (templatedata, loggedin) => {\n    if (bannerisopen) {\n        return;\n    }\n    bannerisopen = true;\n\n    return Templates.renderForPromise('local_cookiebanner/bannercard', {\n        'templatedata': templatedata\n    }).then(async ({ html, js }) => {\n        const container = document.createElement('div');\n        container.innerHTML = html;\n        const banner = container.firstElementChild;\n\n        if (!banner) {\n            throw new Error(\"Template did not return valid HTML.\");\n        }\n\n        document.body.appendChild(banner);\n        Templates.runTemplateJS(js);\n\n        const moodleIdCheckbox = banner.querySelector(\"#cookie-moodle-id\");\n\n        // Check current consent state from IndexedDB\n        const consent = await getDBItem(\"cookie_consent_remember\");\n        if (moodleIdCheckbox && consent === \"setall\") {\n            moodleIdCheckbox.checked = true;\n        }\n\n        const closeBanner = () => {\n            banner.remove();\n            bannerisopen = false;\n        };\n\n        banner.querySelector(\"#cookie-accept-all\")?.addEventListener(\"click\", async () => {\n            await setDBItem(\"cookie_consent_remember\", \"all\");\n            closeBanner();\n            if (loggedin) {\n                Setcookie.init();\n            }\n        });\n\n        banner.querySelector(\"#cookie-save\")?.addEventListener(\"click\", async () => {\n            const moodleIdCheckbox = banner.querySelector(\"#cookie-moodle-id\");\n            if (moodleIdCheckbox?.checked) {\n                await setDBItem(\"cookie_consent_remember\", \"all\");\n                console.log('cookie_consent_remember all');\n\n            } else {\n                await setDBItem(\"cookie_consent_remember\", \"tech\");\n                console.log('cookie_consent_remember tech');\n            }\n            closeBanner();\n            Setcookie.init();\n        });\n\n        // Optional advanced settings modal logic (commented out)\n        // const settingsButton = banner.querySelector(\"#cookie-settings\");\n        // if (templatedata.showadvanced && settingsButton) {\n        //     settingsButton.addEventListener(\"click\", () => {\n        //         ModalFactory.create({\n        //             title: getString('modalheader', 'local_cookiebanner'),\n        //             body: templatedata.advancedtext,\n        //         }).then(modal => modal.show())\n        //           .catch(error =>\n        //             console.error('Modal creation failed:', error));\n        //     });\n        // } else if (settingsButton) {\n        //     settingsButton.style.display = \"none\";\n        // }\n\n        return null;\n    }).catch(error => {\n        console.error('Failed to render cookie banner:', error);\n        bannerisopen = false; // Reset lock on failure\n    });\n};\n\nexport const init = async (data, loggedin) => {\n    const consent = await getDBItem(\"cookie_consent_remember\");\n    if (consent) {\n        return Promise.resolve();\n    }\n    return showbanner(data, loggedin);\n};\n"],"names":["bannerisopen","showbanner","async","templatedata","loggedin","Templates","renderForPromise","then","html","js","container","document","createElement","innerHTML","banner","firstElementChild","Error","body","appendChild","runTemplateJS","moodleIdCheckbox","querySelector","consent","checked","closeBanner","remove","addEventListener","Setcookie","init","console","log","catch","error","data","Promise","resolve"],"mappings":";;;;;g3BAYIA,cAAe,QAENC,WAAaC,MAAOC,aAAcC,gBACvCJ,oBAGJA,cAAe,EAERK,mBAAUC,iBAAiB,gCAAiC,cAC/CH,eACjBI,MAAKL,MAAAA,4DAAOM,KAAEA,KAAFC,GAAQA,eACbC,UAAYC,SAASC,cAAc,OACzCF,UAAUG,UAAYL,WAChBM,OAASJ,UAAUK,sBAEpBD,aACK,IAAIE,MAAM,uCAGpBL,SAASM,KAAKC,YAAYJ,2BAChBK,cAAcV,UAElBW,iBAAmBN,OAAOO,cAAc,qBAGxCC,cAAgB,iBAAU,2BAC5BF,kBAAgC,WAAZE,UACpBF,iBAAiBG,SAAU,SAGzBC,YAAc,KAChBV,OAAOW,SACPzB,cAAe,wCAGnBc,OAAOO,cAAc,8EAAuBK,iBAAiB,SAASxB,gBAC5D,iBAAU,0BAA2B,OAC3CsB,cACIpB,UACAuB,UAAUC,yCAIlBd,OAAOO,cAAc,0EAAiBK,iBAAiB,SAASxB,gBACtDkB,iBAAmBN,OAAOO,cAAc,qBAC1CD,MAAAA,kBAAAA,iBAAkBG,eACZ,iBAAU,0BAA2B,OAC3CM,QAAQC,IAAI,uCAGN,iBAAU,0BAA2B,QAC3CD,QAAQC,IAAI,iCAEhBN,cACAG,UAAUC,UAkBP,QACRG,OAAMC,QACLH,QAAQG,MAAM,kCAAmCA,OACjDhC,cAAe,mDAIHE,MAAO+B,KAAM7B,iBACP,iBAAU,2BAErB8B,QAAQC,UAEZlC,WAAWgC,KAAM7B"}